@using Blazorise.DataGrid
@using F3Core
@using F3Core.Regions
@using F3Wasm.Data
@using F3Wasm.Models
@using System.Text
@inject HttpClient Http

<style>
    th {
        font-size: 12px;
    }

    table td {
        vertical-align: middle !important;
    }
</style>

<div class="mb-2" style="font-style:italic">The Forge Challenge is achieving 200 posts, attending each location 4 times, 10 Qs, attending Q Source 10 times, leading 2 Q Source sessions, bringing 1 FNG, and attending 1 5K in @DateTime.Now.Year.</div>

<button class="btn btn-primary mb-2" @onclick="ExportToCsv">Export To Csv</button>

<DataGrid TItem="ForgeDisplayRow"
          Data="@ForgeRows"
          ShowPager="true"
          SortMode="DataGridSortMode.Single"
          PageSize="25"
          Responsive="true"
          ShowPageSizes="true"
          PagerOptions="new(){ ButtonRowPosition=PagerElementPosition.Start }"
          SelectedRowChanged="OnSelectedRowChanged">
    <DataGridColumns>

        <!-- PAX Name -->
        <DataGridColumn TItem="ForgeDisplayRow"
                        Caption="Name"
                        Sortable="true"
                        Width="90px"
                        SortField="@nameof(ForgeDisplayRow.PaxName)">
            <DisplayTemplate>
                <Span Style="font-weight:600;font-size:12px;vertical-align:middle;">@context.PaxName</Span>
            </DisplayTemplate>
        </DataGridColumn>

        <DataGridColumn TItem="ForgeDisplayRow"
                        Caption="The Forge Challenge %"
                        Filterable="false"
                        Sortable="true">
            <DisplayTemplate>
                <!-- Multi-row flex container with wrapping -->
                <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: flex-start;">
                    <ProgressContainer Label="Posts" Value="@context.TotalPosts" MaxValue="TotalPostsMax" Color="Color.Success" />
                    <ProgressContainer Label="All Sites 4x" Value="@context.CompletedSites" MaxValue="CompletedSitesMax" Color="Color.Info" />
                    <ProgressContainer Label="Qs" Value="@context.QCount" MaxValue="QCountMax" Color="Color.Warning" />
                    <ProgressContainer Label="Q Source" Value="@context.QSourceAttendCount" MaxValue="QSourceAttendMax" Color="Color.Link" />
                    <ProgressContainer Label="Q Source Qs" Value="@context.QSourceLeadCount" MaxValue="QSourceLeadMax" Color="Color.Primary" />
                    <ProgressContainer Label="FNGs" Value="@context.NumberOfFngs" MaxValue="FngMax" Color="Color.Danger" />
                    <ProgressContainer Label="5Ks" Value="@context.NumberOf5Ks" MaxValue="FiveKMax" Color="Color.Secondary" />
                </div>
            </DisplayTemplate>
        </DataGridColumn>

    </DataGridColumns>
</DataGrid>

<AoChallengeModal
    @bind-Visible="showAoChallengeModal"
    SelectedPax="selectedPax"
    SelectedPaxPosts="selectedPaxPosts"
    Aos="AllData.Aos"
    RegionInfo="RegionInfo"
    CurrentView="OverallView.ForgeChallenge"
/>

@code {
    [Parameter]
    public AllData AllData { get; set; }

    [Parameter]
    public string FilterValue { get; set; }

    [Parameter]
    public Region RegionInfo { get; set; }

    private List<ForgeChallenge> ForgeChallengeData { get; set; }

    [Inject]
    private IJSRuntime JSRuntime { get; set; }

    public List<ForgeDisplayRow> ForgeRows { get; set; }
    private bool showAoChallengeModal { get; set; }
    private Pax selectedPax { get; set; }
    private List<Post> selectedPaxPosts { get; set; }

    // Challenge requirements constants
    private static int TotalPostsMax = 200;
    private static int QCountMax = 10;
    private static int QSourceAttendMax = 10;
    private static int QSourceLeadMax = 2;
    private static int FngMax = 1;
    private static int FiveKMax = 1;
    private int CompletedSitesMax = 0; // Will be calculated based on number of AOs

    protected override async Task OnInitializedAsync()
    {
        ForgeChallengeData = await LambdaHelper.GetForgeChallengeDataAsync(Http);
    }

    protected override async Task OnParametersSetAsync()
    {
        var thisYear = DateTime.Now.Year;
        var posts = AllData.Posts.Where(x => x.Date.Year == thisYear).ToList();
        var qSourcePosts = AllData.QSourcePosts?.Where(x => x.Date.Year == thisYear).ToList() ?? new List<Post>();
        var allValidAos = AllData.Aos;

        // Calculate CompletedSitesMax: total number of AOs that need to be visited 4 times
        CompletedSitesMax = allValidAos.Count;

        // Group posts by PAX
        var paxPosts = posts.GroupBy(p => p.Pax).ToDictionary(g => g.Key, g => g.OrderBy(x => x.Date).ToList());
        var paxQSourcePosts = qSourcePosts.GroupBy(p => p.Pax).ToDictionary(g => g.Key, g => g.OrderBy(x => x.Date).ToList());

        ForgeRows = new List<ForgeDisplayRow>();

        // Create a dictionary to quickly look up the Forge challenge data by PAX name
        var challengeDataByPax = ForgeChallengeData.ToDictionary(c => c.PaxName, c => c);

        foreach (var pax in paxPosts.Keys)
        {
            var postCount = paxPosts[pax].Count;
            var qCount = paxPosts[pax].Count(x => x.IsQ);
            var qSourceAttendCount = paxQSourcePosts.ContainsKey(pax) ? paxQSourcePosts[pax].Count : 0;
            var qSourceLeadCount = paxQSourcePosts.ContainsKey(pax) ? paxQSourcePosts[pax].Count(x => x.IsQ) : 0;

            // Get the Forge challenge data for this PAX, or use default values if not found
            var challengeData = challengeDataByPax.ContainsKey(pax) ? challengeDataByPax[pax] : new ForgeChallenge();

            // Calculate how many sites have been attended 4+ times
            var siteAttendanceCounts = paxPosts[pax]
                .Where(x => allValidAos.Any(ao => ao.Name == x.Site))
                .GroupBy(x => x.Site)
                .Select(g => new { Site = g.Key, Count = g.Count() })
                .ToList();

            var completedSites = siteAttendanceCounts.Count(x => x.Count >= 4);

            ForgeRows.Add(new ForgeDisplayRow
            {
                PaxName = pax,
                TotalPosts = postCount,
                QCount = qCount,
                QSourceAttendCount = qSourceAttendCount,
                QSourceLeadCount = qSourceLeadCount,
                NumberOfFngs = challengeData?.NumberOfFngs ?? 0,
                NumberOf5Ks = challengeData?.NumberOf5Ks ?? 0,
                CompletedSites = completedSites,
                ChallengePercent = CalculateChallengePercent(
                    postCount, completedSites, qCount,
                    qSourceAttendCount, qSourceLeadCount,
                    challengeData?.NumberOfFngs ?? 0,
                    challengeData?.NumberOf5Ks ?? 0)
            });
        }

        if (!string.IsNullOrEmpty(FilterValue))
        {
            ForgeRows = ForgeRows
                .Where(row => row.PaxName.Contains(FilterValue, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }

        ForgeRows = ForgeRows.OrderByDescending(x => x.ChallengePercent).ToList();
    }

    private int CalculateChallengePercent(
        int totalPosts, int completedSites, int qCount,
        int qSourceAttendCount, int qSourceLeadCount,
        int numberOfFngs, int numberOfFiveKs)
    {
        // Calculate individual percentages (capped at 100%)
        int totalPostsPercent = Math.Min(100, GetPercent(totalPosts, TotalPostsMax));
        int completedSitesPercent = Math.Min(100, GetPercent(completedSites, CompletedSitesMax));
        int qCountPercent = Math.Min(100, GetPercent(qCount, QCountMax));
        int qSourceAttendPercent = Math.Min(100, GetPercent(qSourceAttendCount, QSourceAttendMax));
        int qSourceLeadPercent = Math.Min(100, GetPercent(qSourceLeadCount, QSourceLeadMax));
        int fngPercent = Math.Min(100, GetPercent(numberOfFngs, FngMax));
        int fiveKPercent = Math.Min(100, GetPercent(numberOfFiveKs, FiveKMax));

        // Sum of all max values
        int totalMax = TotalPostsMax + CompletedSitesMax + QCountMax + QSourceAttendMax +
                      QSourceLeadMax + FngMax + FiveKMax;

        // Sum of actual values (capped at their respective maximums)
        int totalActual = Math.Min(totalPosts, TotalPostsMax) +
                         Math.Min(completedSites, CompletedSitesMax) +
                         Math.Min(qCount, QCountMax) +
                         Math.Min(qSourceAttendCount, QSourceAttendMax) +
                         Math.Min(qSourceLeadCount, QSourceLeadMax) +
                         Math.Min(numberOfFngs, FngMax) +
                         Math.Min(numberOfFiveKs, FiveKMax);

        // Overall percentage
        return (int)((double)totalActual / totalMax * 100);
    }

    private int GetPercent(int value, int max)
    {
        if (max == 0) return 0;
        return (int)((double)value / max * 100);
    }

    private async Task ExportToCsv()
    {
        var csv = new StringBuilder();

        // Add header row
        csv.AppendLine("PaxName,TotalPosts,CompletedSites,QCount,QSourceAttendCount,QSourceLeadCount,NumberOfFngs,NumberOf5Ks,ChallengePercent");

        // Add data rows
        foreach (var item in ForgeRows)
        {
            csv.AppendLine($"{item.PaxName},{item.TotalPosts},{item.CompletedSites},{item.QCount}," +
                          $"{item.QSourceAttendCount},{item.QSourceLeadCount},{item.NumberOfFngs},{item.NumberOf5Ks},{item.ChallengePercent}");
        }

        await JSRuntime.InvokeVoidAsync("downloadFile", $"ForgeChallenge_{DateTime.Now.ToShortDateString()}.csv", csv.ToString());
    }

    private async Task OnSelectedRowChanged(ForgeDisplayRow row)
    {
        if (row == null) return;

        selectedPax = AllData.Pax.FirstOrDefault(p => p.Name?.Trim() == row.PaxName?.Trim());
        var thisYear = DateTime.Now.Year;
        selectedPaxPosts = AllData.Posts.Where(p => p.Pax?.Trim() == row.PaxName?.Trim() && p.Date.Year == thisYear).ToList();
        showAoChallengeModal = true;
    }

    public class ForgeDisplayRow
    {
        public string PaxName { get; set; }
        public int TotalPosts { get; set; }
        public int CompletedSites { get; set; }
        public int QCount { get; set; }
        public int QSourceAttendCount { get; set; }
        public int QSourceLeadCount { get; set; }
        public int NumberOfFngs { get; set; }
        public int NumberOf5Ks { get; set; }
        public int ChallengePercent { get; set; }
    }
}
