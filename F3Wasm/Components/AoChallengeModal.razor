@using Blazorise
@using F3Core
@using F3Core.Regions
@using F3Wasm.Data
@using F3Wasm.Models

<Modal @bind-Visible="@Visible" id="AoChallengeModal" Closing="@OnModalClosing">
    @if (SelectedPax != null)
    {
        <ModalContent Centered Size="ModalSize.Fullscreen">
            <ModalHeader>
                <ModalTitle>@SelectedPax.Name</ModalTitle>
                <CloseButton />
            </ModalHeader>
            <ModalBody>
                <Column>
                    <h4>AOs Posted</h4>
                    <div class="aoChallengeContainer">
                        @foreach (var location in Aos.OrderBy(x => x.DayOfWeek).ToList())
                        {
                            var hasQd = HasQdAtLocation(location);
                            @if (RegionInfo.DisplayName == "Mother Lode" && CurrentView == OverallView.ForgeChallenge)
                            {
                                var postCount = GetPostCountForLocation(location);
                                <Button class="aoChallengeButton"
                                    style="@($"{GetAoChallengeButtonColor(location)} position: relative;")">
                                    @location.Name<br/>
                                    <span style="font-size: .8em;">@postCount</span>
                                    @if (hasQd)
                                    {
                                        <span style="position: absolute; top: 4px; right: 4px; font-size: .7em; font-weight: bold; background-color: rgba(255,255,255,0.9); color: #000; padding: 2px 5px; border-radius: 3px; line-height: 1;">✓Q</span>
                                    }
                                </Button>
                            }
                            else
                            {
                                <Button class="aoChallengeButton"
                                    style="@($"{GetAoChallengeButtonColor(location)} position: relative;")">
                                    @location.Name
                                    @if (hasQd)
                                    {
                                        <span style="position: absolute; bottom: 4px; right: 4px; font-size: .7em; font-weight: bold; background-color: rgba(255,255,255,0.9); color: #000; padding: 2px 5px; border-radius: 3px; line-height: 1;">✓Q</span>
                                    }
                                </Button>
                            }
                        }
                        @if (RegionInfo.DisplayName == "South Fork")
                        {
                            var hasQd = HasQdAtLocation(FullMoonRuckAo);
                            <Button class="aoChallengeButton"
                                style="@($"{GetAoChallengeButtonColor(FullMoonRuckAo)} position: relative;")">
                                Full Moon Ruck
                                @if (hasQd)
                                {
                                    <span style="position: absolute; bottom: 4px; right: 4px; font-size: .7em; font-weight: bold; background-color: rgba(255,255,255,0.9); color: #000; padding: 2px 5px; border-radius: 3px; line-height: 1;">✓Q</span>
                                }
                            </Button>
                        }
                    </div>
                </Column>
            </ModalBody>
            <ModalFooter>
                <Button Color="Color.Secondary" Clicked="@HideModal">Close</Button>
            </ModalFooter>
        </ModalContent>
    }
</Modal>

<style>
    .aoChallengeButton {
        height: 75px;
    }

    .aoChallengeContainer {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
    }
</style>

@code {
    [Parameter]
    public bool Visible { get; set; }

    [Parameter]
    public EventCallback<bool> VisibleChanged { get; set; }

    [Parameter]
    public Pax SelectedPax { get; set; }

    [Parameter]
    public List<Post> SelectedPaxPosts { get; set; }

    [Parameter]
    public List<Ao> Aos { get; set; }

    [Parameter]
    public Region RegionInfo { get; set; }

    [Parameter]
    public OverallView CurrentView { get; set; }

    public string FullMoonRuckName = "Full Moon Ruck";
    public Ao FullMoonRuckAo = new Ao() { Name = "Full Moon Ruck" };

    private Task HideModal()
    {
        Visible = false;
        return VisibleChanged.InvokeAsync(Visible);
    }

    private Task OnModalClosing(ModalClosingEventArgs e)
    {
        return Task.CompletedTask;
    }

    private int GetPostCountForLocation(Ao location)
    {
        var now = DateTime.Now;
        return SelectedPaxPosts.Where(x => x.Date.Year == now.Year && x.Site == location.Name).Count();
    }

    private bool HasQdAtLocation(Ao location)
    {
        var now = DateTime.Now;
        return SelectedPaxPosts.Any(x => x.Date.Year == now.Year && x.Site == location.Name && x.IsQ);
    }

    private string GetAoChallengeButtonColor(Ao location)
    {
        // Full Moon Ruck is always black
        var hex = "#423c3f";

        if (location.Name != FullMoonRuckName)
        {
            hex = ColorHelpers.GetAoHex(location);
        }

        var now = DateTime.Now;
        var hasPosted = false;

        if (CurrentView == OverallView.AoChallenge)
        {
            // Only show posts from November 1st to December 14th
            hasPosted = SelectedPaxPosts.Where(x => x.Date.Year == now.Year && (x.Date.Month == 11 || (x.Date.Month == 12 && x.Date.Day <= 14)) && x.Site == location.Name).Any();
        }
        else if (CurrentView == OverallView.SouthForkChallenge)
        {
            // Show posts for entire year
            hasPosted = SelectedPaxPosts.Where(x => x.Date.Year == now.Year && x.Site == location.Name).Any();
        }
        else if (CurrentView == OverallView.TerracottaChallenge)
        {
            hasPosted = SelectedPaxPosts.Where(x => x.Date.Year == now.Year && x.Site == location.Name).Any();
        }
        else if (CurrentView == OverallView.ForgeChallenge)
        {
            // For Forge Challenge, show filled if 4+ posts, otherwise outlined
            var postCount = GetPostCountForLocation(location);
            if (postCount >= 4)
            {
                return $"background-color: {hex}; color: white;";
            }
            return $"border: solid 1px {hex}; color:{hex}";
        }
        else
        {
            hasPosted = SelectedPaxPosts.Where(x => x.Date.Year == now.Year && x.Date.Month == now.Month && x.Site == location.Name).Any();
        }

        if (hasPosted)
        {
            return $"background-color: {hex}; color: white;";
        }

        return $"border: solid 1px {hex}; color:{hex}";
    }
} 